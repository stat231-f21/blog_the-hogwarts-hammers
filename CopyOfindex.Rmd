---
title: "Suicide Rates Across the World"
author: "Victoria Kuntz and Rohil Bathija"
date: "December 8th 2021"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: "kate"
---

```{r setup, include = FALSE}
library(tidyverse)
library(kableExtra)
library(viridis)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(plotly)
library(rgeos)
library(rgdal)
library(leaflet)
library(RColorBrewer)
# for example code; delete if not needed

# Set code chunk defaults
knitr::opts_chunk$set(
  echo = FALSE,
  mesage = FALSE,
  warning = FALSE,
  fig.align = "center"
)

# Set R environment options
options(knitr.kable.NA = "")
```

```{r reading-data, eval = TRUE, include = FALSE}
MHBeds <- read_csv("data/mental-health-hospital.csv", show_col_types = FALSE)
suicideRate <- read_csv("data/suicide-death-rates.csv", show_col_types = FALSE)
sexualViolence <- read_csv("data/NonPartnerSexualViolenceByCountry.csv", show_col_types = FALSE)
suicideState <- read_csv("data/StateData.csv", show_col_types = FALSE) %>%
  rename(id = "STATE")
gunData <- read_csv("data/gunOwnership.csv")
maleFemaleRatio <- read_csv("data/Male-Female-Ratio-of-Suicide-Rates.csv")
leafletData <- readOGR(
  dsn = paste0(getwd(), "/data/LeafletData"),
  layer = "TM_WORLD_BORDERS_SIMPL-0.3",
  verbose = FALSE
)
```
#VIETTA
```{r wrangling, include = FALSE}
# Rename country codes and years and drop unnecessary columns so that all data sets match
maleFemaleRatio <- maleFemaleRatio %>%
  mutate(ISO3 = Code)
suicideRate <- suicideRate %>%
  mutate(ISO3 = Code)
MHBeds <- MHBeds %>%
  select("GHO_DISPLAY", "YEAR", "COUNTRY_CODE", "Number_Beds") %>%
  mutate(ISO3 = COUNTRY_CODE, Year = YEAR)

# Pull out different bed metrics into separate data sets
MHBedsInMHHospitals <- MHBeds %>%
  filter(GHO_DISPLAY == "Beds in mental hospitals (per 100 000 population)") %>%
  mutate(BEDS_IN_MENTAL_HOSPITALS = Number_Beds) %>%
  select(Year, ISO3, BEDS_IN_MENTAL_HOSPITALS)
MHBedsInGeneralHospitals <- MHBeds %>%
  filter(GHO_DISPLAY == "Beds for mental health in general hospitals (per 100 000 population)") %>%
  mutate(BEDS_IN_GENERAL_HOSPITALS = Number_Beds) %>%
  select(Year, ISO3, BEDS_IN_GENERAL_HOSPITALS)
MHBedsInCommunityHospitals <- MHBeds %>%
  filter(GHO_DISPLAY == "Beds in community residential facilities (per 100 000 population)") %>%
  mutate(BEDS_IN_COMMUNITY_FACILITIES = Number_Beds) %>%
  select(Year, ISO3, BEDS_IN_COMMUNITY_FACILITIES)

# Combine bed data into a single data set and replace NA with 0
bedData2016 <- full_join(MHBedsInMHHospitals, full_join(MHBedsInGeneralHospitals, MHBedsInCommunityHospitals)) %>%
  replace_na(list(BEDS_IN_MENTAL_HOSPITALS = 0, BEDS_IN_GENERAL_HOSPITALS = 0, BEDS_IN_COMMUNITY_FACILITIES = 0)) %>%
  mutate(TOTAL_BEDS = BEDS_IN_MENTAL_HOSPITALS + BEDS_IN_GENERAL_HOSPITALS + BEDS_IN_COMMUNITY_FACILITIES) %>%
  filter(Year == 2016)

# Join together all data sets into a single data set for display
suicideData <- full_join(suicideRate, maleFemaleRatio)
suicideData <- full_join(suicideData, bedData2016)
suicideData2016 <- suicideData %>%
  filter(Year == "2016")
write_csv(suicideData, "fullSuicideData.csv")
maleFemaleRatio2017 <- maleFemaleRatio %>%
  filter(Year == "2017")

leafletMaleFemaleRatio2017 <- merge(leafletData, maleFemaleRatio2017, by = "ISO3")
leafletSuicideData2016 <- merge(leafletData, suicideData2016, by = "ISO3")
```

```{r, include = FALSE}
# Get all years into one row of the data frame
wideSuicideData <- NULL
for (year in 1990:2017) {
  dataForYear <-
    suicideData %>%
    filter(Year == year) %>%
    select(ISO3, SuicideDeathRate) %>%
    drop_na()
  rateName <- paste("Rate", year, sep = "")
  dataForYear[rateName] <- dataForYear$SuicideDeathRate
  dataForYear <- dataForYear %>% select("ISO3", rateName)
  if (is.null(wideSuicideData)) {
    wideSuicideData <- dataForYear
  } else {
    wideSuicideData <- full_join(wideSuicideData, dataForYear, by = c("ISO3"))
  }
}
write_csv(wideSuicideData, "suicideRatesWideYears.csv")
```

## Introduction
 Suicide is consistently one of the leading causes of death in the world. 
 
```{r usSuicideRates}
usSuicideRatesPost2000 <- suicideRate %>%
  filter(Code == "USA", Year >= 2000)
ggplot(usSuicideRatesPost2000, aes(x = Year, y = SuicideDeathRate)) +
  geom_line()
```

## Data
  Insert information on where data was obtained
  
## What do suicide rates look like around the world?
  Insert 2016 plot
```{r, echo=FALSE}
mybins <- c(0, 1, 2, 5, 7, 10, 12, 15, 20, 25, 30, 50, 100)
myPalette <- colorBin(
  palette = c(
    "#333399",
    "#555599",
    "#777799",
    "#999999",
    "#ffcccc",
    "#ffaaaa",
    "#ff9999",
    "#ff7777",
    "#cc5555",
    "#aa0000",
    "#550000",
    "#330000"
  ),
  domain = leafletSuicideData2016,
  na.color = "transparent",
  bins = mybins
)
hoverText <-
  paste(
    "Country: ", leafletSuicideData2016@data$NAME, "<br/>",
    "Suicide Rate (2016): ", leafletSuicideData2016$SuicideDeathRate, "<br/>",
    sep = ""
  ) %>%
  lapply(htmltools::HTML)
leaflet(leafletSuicideData2016) %>%
  addTiles() %>%
  setView(lat = 30, lng = 0, zoom = 1.5) %>%
  addLegend(pal = myPalette, values = leafletSuicideData2016$SuicideDeathRate, opacity = .7, title = "Suicide Death Rate<br/>Per 100k", position = "bottomleft") %>%
  addCircles(
    lat = leafletSuicideData2016$LAT, lng = leafletSuicideData2016$LON,
    radius = leafletSuicideData2016$SuicideDeathRate * 10000,
    opacity = 1,
    fillOpacity = .7,
    weight = 1,
    group = "circles",
    color = myPalette(leafletSuicideData2016$SuicideDeathRate),
    fillColor = myPalette(leafletSuicideData2016$SuicideDeathRate),
    label = hoverText,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "13px",
      direction = "auto"
    )
  )
```

  
### What if we look at throughout history?
  Do we see any trends?
  insert shiny app
  Looks like the 20 degrees north of the equator looks much better
  
### What other trends do we see?
  Russia and neighboring countries increase after soviet union fall

## What is the US saying about mental health needs?
  Insert word cloud
  
### Does having more mental health hospital beds actually correlate with lower suicide rates?
  No!
  
## Limitations

## Further exploration
```{r leaflet, include = FALSE}
mybins <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
mypalette <- colorBin(
  palette = c("#ff0000", "#ddddff", "#bbbbff", "#9999ff", "#7777ff", "#5555ff", "#3333cc", "#1111aa", "#000099", "#000055", "#000000"),
  domain = leafletSuicideData2016@data$MaleFemaleSuicideRatio,
  na.color = "transparent",
  bins = mybins
)

# Prepare the text for tooltips:
hoverText <- paste(
  "Country: ", leafletSuicideData2016@data$NAME, "<br/>",
  "Suicide Rate: ", round(leafletSuicideData2016@data$SuicideDeathRate, 2), "<br/>",
  "Ratio of male to female suicide: ", round(leafletSuicideData2016@data$MaleFemaleSuicideRatio, 2),
  sep = ""
) %>%
  lapply(htmltools::HTML)

# Final Map
leaflet(leafletSuicideData2016) %>%
  addTiles() %>%
  setView(lat = 10, lng = 0, zoom = 2) %>%
  addPolygons(
    fillColor = ~ mypalette(MaleFemaleSuicideRatio),
    stroke = TRUE,
    fillOpacity = 1,
    color = "white",
    weight = 1,
    label = hoverText,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "13px",
      direction = "auto"
    )
  ) %>%
  addLegend(pal = mypalette, values = ~MaleFemaleSuicideRatio, opacity = 1, title = "Ratio of Male to Female Suicide", position = "bottomleft")
```


```{r worldMap2, include = FALSE}
mybins <- c(0, 1, 2, 5, 7, 10, 12, 15, 20, 25, 30, Inf)
mypalette <- colorBin(
  palette = c(
    "#333399",
    "#555599",
    "#777799",
    "#999999",
    "#ffcccc",
    "#ffaaaa",
    "#ff9999",
    "#ff7777",
    "#cc5555",
    "#aa0000",
    "#550000"
  ),
  domain = leafletSuicideData2016@data$SuicideDeathRate,
  na.color = "transparent",
  bins = mybins
)

# Prepare the text for tooltips:
hoverText <- paste(
  "Country: ", leafletSuicideData2016@data$NAME, "<br/>",
  "Total MH Beds: ", leafletSuicideData2016@data$TOTAL_BEDS, "<br/>",
  "Suicide Rate: ", round(leafletSuicideData2016@data$SuicideDeathRate, 2), "<br/>",
  "Ratio of male to female suicide: ", round(leafletSuicideData2016@data$MaleFemaleSuicideRatio, 2),
  sep = ""
) %>%
  lapply(htmltools::HTML)

# Final Map
leaflet(leafletSuicideData2016) %>%
  addTiles() %>%
  setView(lat = 10, lng = 0, zoom = 2) %>%
  addPolygons(
    fillColor = ~ mypalette(SuicideDeathRate),
    stroke = TRUE,
    fillOpacity = 1,
    color = "white",
    weight = 1,
    label = hoverText,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "13px",
      direction = "auto"
    )
  ) %>%
  addLegend(pal = mypalette, values = ~SuicideDeathRate, opacity = 1, title = "Suicide Death Rate", position = "bottomleft")
```

```{r worldMap3, include = FALSE}
mybins <- c(0, 1, 2, 3, 4, 5, 8, 10, 15, 20, 50, 100)
mypaletteDeathRate <- colorBin(
  palette = c("#ffffff", "#ddddff", "#bbbbff", "#9999ff", "#7777ff", "#5555ff", "#3333cc", "#1111aa", "#000099", "#000055", "#000000"),
  domain = leafletSuicideData2016@data$SuicideDeathRate,
  na.color = "transparent",
  bins = mybins
)

mybins <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)

mypaletteMaleFemale <- colorBin(
  palette = c("#009900", "#0000ff", "#2200dd", "#4400aa", "#660099", "#880077", "#aa0066", "#bb0055", "#cc0033", "#ee0011", "#ff0000"),
  domain = leafletSuicideData2016@data$MaleFemaleSuicideRatio,
  na.color = "transparent",
  bins = mybins
)
# Prepare the text for tooltips:
hoverText <- paste(
  "Country: ", leafletSuicideData2016@data$NAME, "<br/>",
  "Total MH Beds: ", leafletSuicideData2016@data$TOTAL_BEDS, "<br/>",
  "Suicide Rate: ", round(leafletSuicideData2016@data$SuicideDeathRate, 2), "<br/>",
  "Ratio of male to female suicide: ", round(leafletSuicideData2016@data$MaleFemaleSuicideRatio, 2),
  sep = ""
) %>%
  lapply(htmltools::HTML)

# Final Map
leaflet(leafletSuicideData2016) %>%
  addTiles() %>%
  setView(lat = 30, lng = 0, zoom = 1.6) %>%
  addPolygons(
    fillColor = ~ mypaletteDeathRate(SuicideDeathRate),
    stroke = TRUE,
    fillOpacity = 0,
    opacity = 0,
    color = "black",
    weight = 1,
    label = hoverText,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "13px",
      direction = "auto"
    )
  ) %>%
  addCircles(lat = leafletSuicideData2016@data$LAT, lng = leafletSuicideData2016@data$LON, weight = 1, opacity = 1, fillOpacity = .7, radius = sqrt(leafletSuicideData2016@data$SuicideDeathRate) * 40000, color = "white", fillColor = mypaletteMaleFemale(leafletSuicideData2016@data$MaleFemaleSuicideRatio)) %>%
  #  addLegend(pal = mypaletteDeathRate, values = ~SuicideDeathRate, opacity = 1, title = "Suicide Death Rate", position = "bottomleft") %>%
  addLegend(pal = mypaletteMaleFemale, values = ~MaleFemaleSuicideRatio, opacity = .7, title = "Male Female Ratio", position = "bottomleft")
```



#ROHIL
##Map of suicide by state
```{r usMap, echo = FALSE, fig.width = 8, fig.height = 4, fig.align="center"}
data(state)
#need a master dataset for state name, and abbreviations
state_info <- data.frame(
  Region = state.region,
  # Match state variable name in map data
  state = tolower(state.name),
  # Match state variable name in summary data
  id = state.abb
)
#creating one dataset where all the suicide info will be
SuicideStateWithInfo <- suicideState %>%
  #added in state name and abbreviations
  left_join(state_info, by = "id") %>%
  #only want the most recent year (one year of data)
  filter(YEAR == "2019") %>%
  select(c("YEAR", "id", "RATE", "DEATHS", "Region", "state")) %>%
  #renaming the id columns so that future joins work
  rename(region = "Region", state = "id", id = "state")
rename(state_info, id = "state", state = "id")
#this is the object needed for the geospatial representation
state_map <- maps::map("state", plot = FALSE, fill = TRUE) %>%
  st_as_sf() %>%
  #changed capitalization for joins
  rename(id = "ID")

#created the object to be plotted along with the data
graphs_map <- state_map %>%
  left_join(SuicideStateWithInfo, by = "id")

#shows the map with distribution of total deaths
#decided to comment it out and not use it because it doesn't show anything but population density

#y <- ggplot(graphs_map, aes(fill = DEATHS, text = paste("State: ", id))) +
  #geom_sf(size = .2, colour = "white") +
  #scale_fill_viridis(option = "magma", direction = -1)
#theme_void()
#ggplotly(y, dynamicTicks = TRUE)

#created plot object with us map and have labeled text for the hover feature of plotly
x <- ggplot(graphs_map, aes(fill = RATE, text = paste("State: ", id))) +
  geom_sf(size = .2, colour = "white") +
  scale_fill_viridis(option = "magma", direction = -1) +
  #adding legend title and title
  labs(fill = "Suicide Rate",
       title = "Suicide Rate (per 100,000 people) by State")
theme_void()
# plotting the plot object dynamically
ggplotly(x, dynamicTicks = TRUE)
```

```{r GunMap, echo= FALSE, fig.width = 8, fig.height = 4, fig.align="center"}
#creating new dataset with all the information in one place
gunDataNew <- gunData %>%
  #capitalization change for join below
  mutate(state = tolower(State)) %>%
  left_join(state_info, by = "state") %>%
  select(id, state, gunOwnership, totalGuns)
#creating the sf object using the previous one and renaming the id to state
#to match gunDataNew
state_map_new <- state_map %>%
  rename(state = id)
#creating the final dataset to use for plot
graphs_map_guns <- state_map_new %>%
  left_join(gunDataNew, by = "state")
#creating plot object with dynamic text
y <- ggplot(graphs_map_guns, aes(fill = gunOwnership, text = paste("State: ", state))) +
  geom_sf(size = .2, colour = "white") +
  scale_fill_viridis(option = "magma", direction = -1) +
  #adding title and legend title
  labs(fill = "Gun Ownership",
       title = "Percentage of Gun Owners by State")
theme_void()
#plotting object
ggplotly(y, dynamicTicks = TRUE)
```

```{r suicideGun, echo = FALSE, fig.width = 8, fig.height = 5, fig.align="center"}
#wrangling
suicideGun <- SuicideStateWithInfo %>%
  #selecting only the 2 important columns for suicide info
  select(state, RATE) %>%
  #renaming column for joining
  rename(id = state) %>%
  #joining with gun data
  left_join(gunDataNew, by = "id") %>%
  #selecting the 3 important varibale to graph
  select(id, RATE, gunOwnership) %>%
  #renaming for clarity
  rename(State = id, Rate = RATE)
#plotting the data with guns on x axis and suicide rates on y
ggplot(suicideGun, aes(x = gunOwnership, y = Rate)) +
  #adding in points
  geom_point() +
  #adding in labels for each state
  geom_text(aes(label= State), hjust = 0, vjust = -0.5)+
  #adding informative labels
  labs(x = "Gun Ownership (Percentage)", 
       y = "Suicide Rate (per 100,000)",
       title = "Suicide Rate vs Gun Ownership by US State")
```